{% extends "layout.html" %}

{% block title %}Clientes | Pueblo{% endblock %}

{% block content %}

<div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
  <div>
    <h1 class="text-3xl font-bold text-gray-800">Clientes</h1>
    <p class="text-gray-600">Gestión de clientes y sus préstamos</p>
  </div>
  <div class="flex flex-wrap gap-2">
    <button onclick="document.getElementById('new-client-modal').classList.remove('hidden')"
      class="bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-2 rounded-lg flex items-center gap-2">
      <i class="fas fa-plus"></i>
      <span>Nuevo Cliente</span>
    </button>
  </div>
</div>

<!-- KPIs -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
  <div class="bg-white rounded-lg shadow p-4">
    <div class="flex justify-between">
      <div>
        <p class="text-sm font-medium text-gray-500">Clientes totales</p>
        <h3 class="text-2xl font-bold mt-1">{{ total_clientes }}</h3>
      </div>
      <div class="p-3 rounded-full bg-emerald-100 text-emerald-600">
        <i class="fas fa-users text-xl"></i>
      </div>
    </div>
  </div>
  <div class="bg-white rounded-lg shadow p-4">
    <div class="flex justify-between">
      <div>
        <p class="text-sm font-medium text-gray-500">Clientes activos</p>
        <h3 class="text-2xl font-bold mt-1">{{ clientes_activos }}</h3>
      </div>
      <div class="p-3 rounded-full bg-green-100 text-green-600">
        <i class="fas fa-user-check text-xl"></i>
      </div>
    </div>
  </div>
  <div class="bg-white rounded-lg shadow p-4">
    <div class="flex justify-between">
      <div>
        <p class="text-sm font-medium text-gray-500">Clientes en mora</p>
        <h3 class="text-2xl font-bold mt-1">{{ clientes_mora }}</h3>
      </div>
      <div class="p-3 rounded-full bg-red-100 text-red-600">
        <i class="fas fa-exclamation-triangle text-xl"></i>
      </div>
    </div>
  </div>
  <div class="bg-white rounded-lg shadow p-4">
    <div class="flex justify-between">
      <div>
        <p class="text-sm font-medium text-gray-500">Préstamos promedio</p>
        <h3 class="text-2xl font-bold mt-1">{{ promedio_prestamos }}</h3>
      </div>
      <div class="p-3 rounded-full bg-purple-100 text-purple-600">
        <i class="fas fa-chart-line text-xl"></i>
      </div>
    </div>
  </div>
</div>

<!-- Tabla de clientes -->
<div class="bg-white rounded-lg shadow overflow-hidden mb-10">
  <div class="overflow-x-auto">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cliente</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contacto</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Dirección</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Préstamos</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
          <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
        </tr>
      </thead>
     <tbody class="bg-white divide-y divide-gray-200">
  {% for cliente in clientes %}
  <tr class="hover:bg-gray-50">
    <td class="px-6 py-4 whitespace-nowrap">
      <div class="flex items-center">
        <div class="flex-shrink-0 h-10 w-10 rounded-full avatar">
          {{ cliente.nombre.split()[0][0] }}{{ cliente.nombre.split()[1][0] if cliente.nombre|length > 1 and cliente.nombre.split()|length > 1 else '' }}
        </div>
        <div class="ml-4">
          <div class="text-sm font-medium text-gray-900">{{ cliente.nombre }}</div>
          <div class="text-xs text-gray-500">{{ cliente.rut }}</div>
        </div>
      </div>
    </td>
    <td class="px-6 py-4 whitespace-nowrap">
      <div class="text-sm text-gray-900">{{ cliente.correo }}</div>
      <div class="text-xs text-gray-500">{{ cliente.telefono }}</div>
    </td>
    <td class="px-6 py-4 whitespace-nowrap">
      <div class="text-sm">{{ cliente.direccion }}</div>
    </td>
    <td class="px-6 py-4 whitespace-nowrap">
      <div class="text-sm font-medium">{{ cliente.prestamos }}</div>
      <div class="text-xs text-gray-500">${{ "{:,.0f}".format(cliente.total or 0).replace(",", ".") }}</div>
    </td>
    <td class="px-6 py-4 whitespace-nowrap">
      {% if cliente.estado == 'mora' %}
      <span class="px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">Mora</span>
      {% elif cliente.estado == 'pendiente' %}
      <span class="px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">Pendiente</span>
      {% else %}
      <span class="px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Activo</span>
      {% endif %}
    </td>
        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
          <button onclick="verCliente({{ cliente.id }})" class="text-blue-600 hover:text-blue-900 mr-3">
            <i class="fas fa-eye"></i>
          </button>
          <button onclick="editarCliente({{ cliente.id }})" class="text-indigo-600 hover:text-indigo-900 mr-3">
            <i class="fas fa-edit"></i>
          </button>
          <form method="POST" action="/cliente/{{ cliente.id }}/eliminar" class="inline" onsubmit="return confirm('¿Eliminar cliente?')">
            <button class="text-red-600 hover:text-red-900" type="submit">
              <i class="fas fa-trash"></i>
            </button>
          </form>
        </td>
  </tr>
  {% endfor %}
</tbody>
    </table>
  </div>
</div>

<!-- Modal Nuevo Cliente -->
<div id="new-client-modal" class="fixed inset-0 overflow-y-auto z-50 hidden">
  <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
    <div class="fixed inset-0 transition-opacity" aria-hidden="true">
      <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
    </div>
    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

    <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-2xl sm:w-full">
      <form method="POST" action="/clientes" class="bg-white px-6 py-6 space-y-4">
        <div class="flex justify-between items-center">
          <h3 class="text-xl font-semibold text-gray-900">Nuevo Cliente</h3>
          <button type="button" onclick="document.getElementById('new-client-modal').classList.add('hidden')" class="text-gray-400 hover:text-gray-500">
            <i class="fas fa-times"></i>
          </button>
        </div>

        <div><label class="block text-sm font-medium text-gray-700 mb-1">Nombre</label>
          <input type="text" name="nombre" required placeholder="Ej: Juan Pérez" class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-emerald-500 focus:border-emerald-500" />
        </div>

        <div><label class="block text-sm font-medium text-gray-700 mb-1">RUT</label>
          <input type="text" name="rut" placeholder="12.345.678-9" class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-emerald-500 focus:border-emerald-500" />
        </div>

        <div><label class="block text-sm font-medium text-gray-700 mb-1">Correo</label>
          <input type="email" name="correo" required placeholder="correo@dominio.cl" class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-emerald-500 focus:border-emerald-500" />
        </div>

        <div><label class="block text-sm font-medium text-gray-700 mb-1">Teléfono</label>
          <input type="tel" name="telefono" placeholder="+56 9 1234 5678" class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-emerald-500 focus:border-emerald-500" />
        </div>

        <div><label class="block text-sm font-medium text-gray-700 mb-1">Dirección</label>
          <input type="text" name="direccion" placeholder="Ciudad, calle o referencia" class="w-full border border-gray-300 rounded px-3 py-2 text-sm focus:ring-emerald-500 focus:border-emerald-500" />
        </div>

        <div class="flex justify-end gap-2 pt-4">
          <button type="button" onclick="document.getElementById('new-client-modal').classList.add('hidden')" class="px-4 py-2 text-sm border rounded text-gray-600 hover:bg-gray-100">Cancelar</button>
          <button type="submit" class="bg-emerald-500 hover:bg-emerald-600 text-white text-sm px-5 py-2 rounded">Guardar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal VER -->
<div id="modalVer" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
  <div class="bg-white rounded-lg shadow-xl max-w-md mx-auto mt-20 p-6">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-lg font-semibold">Detalle del Cliente</h2>
      <button onclick="cerrarModal('modalVer')" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
    </div>
    <div id="contenidoVer" class="text-sm text-gray-700 space-y-2">
      <!-- contenido dinámico aquí -->
    </div>
  </div>
</div>

<!-- Modal Editar Cliente -->
<div id="modalEditar" class="fixed inset-0 z-50 hidden overflow-y-auto">
  <div class="flex items-center justify-center min-h-screen px-4 text-center">
    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="cerrarModal('modalEditar')"></div>

    <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>
    <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all w-full max-w-lg p-6 z-50">
      <form method="POST" id="formEditar">
        <h3 class="text-xl font-semibold text-gray-900 mb-4">Editar Cliente</h3>

        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1">Nombre</label>
          <input id="edit-nombre" name="nombre" required class="w-full border rounded px-3 py-2 text-sm" />
        </div>

        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1">RUT</label>
          <input id="edit-rut" name="rut" class="w-full border rounded px-3 py-2 text-sm" />
          <p id="rut-error" class="text-red-600 text-xs mt-1 hidden">El RUT ingresado no es válido.</p>
        </div>

        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1">Correo</label>
          <input id="edit-correo" name="correo" class="w-full border rounded px-3 py-2 text-sm" />
          <p id="correo-error" class="text-red-600 text-xs mt-1 hidden">El correo ingresado no es válido.</p>
        </div>

        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1">Teléfono</label>
          <input id="edit-telefono" name="telefono" class="w-full border rounded px-3 py-2 text-sm" />
        </div>

        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1">Dirección</label>
          <input id="edit-direccion" name="direccion" class="w-full border rounded px-3 py-2 text-sm" />
        </div>

        <input type="hidden" id="edit-id" name="id" />
        <div class="flex justify-end gap-2 pt-4">
          <button type="button" onclick="cerrarModal('modalEditar')" class="px-4 py-2 text-sm border rounded text-gray-600 hover:bg-gray-100">Cancelar</button>
          <button type="submit" class="bg-emerald-500 hover:bg-emerald-600 text-white text-sm px-5 py-2 rounded">Guardar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  function cerrarModal(id) {
    document.getElementById(id).classList.add('hidden');
  }

  function formatearFecha(fechaStr) {
  if (!fechaStr) return '-';
  const fecha = new Date(fechaStr);
  return fecha.toLocaleDateString('es-CL');
}

  function verCliente(id) {
    fetch(`/api/cliente/${id}`)
      .then(res => res.json())
      .then(data => {
        const cont = document.getElementById('contenidoVer');
          cont.innerHTML = `
            <p><strong>Nombre:</strong> ${data.nombre}</p>
            <p><strong>RUT:</strong> ${data.rut}</p>
            <p><strong>Correo:</strong> ${data.correo}</p>
            <p><strong>Teléfono:</strong> ${data.telefono}</p>
            <p><strong>Dirección:</strong> ${data.direccion || '-'}</p>
            <p><strong>Estado:</strong> ${data.estado}</p>
            <p><strong>Préstamos:</strong> ${data.prestamos}</p>
            <p><strong>Total:</strong> $${(data.total || 0).toLocaleString('es-CL')}</p>
            <p><strong>Creado:</strong> ${formatearFecha(data.fecha_registro)}</p>
          `;
        document.getElementById('modalVer').classList.remove('hidden');
      });
  }

  function editarCliente(id) {
    fetch(`/api/cliente/${id}`)
      .then(res => res.json())
      .then(data => {
        document.getElementById('edit-id').value = data.id;
        document.getElementById('edit-nombre').value = data.nombre;
        document.getElementById('edit-rut').value = data.rut;
        document.getElementById('edit-correo').value = data.correo;
        document.getElementById('edit-telefono').value = data.telefono;
        document.getElementById('edit-direccion').value = data.direccion || '';
        document.getElementById('formEditar').action = `/cliente/${id}/editar`;
        document.getElementById('modalEditar').classList.remove('hidden');
      });
  }
</script>

<script>
  function validarRut(rut) {
    rut = rut.replace(/\./g, '').replace(/-/g, '');
    if (rut.length < 8) return false;
    const cuerpo = rut.slice(0, -1);
    const dv = rut.slice(-1).toUpperCase();

    let suma = 0;
    let multiplo = 2;
    for (let i = cuerpo.length - 1; i >= 0; i--) {
      suma += parseInt(cuerpo.charAt(i)) * multiplo;
      multiplo = multiplo < 7 ? multiplo + 1 : 2;
    }
    const dvEsperado = 11 - (suma % 11);
    const dvCalc = dvEsperado === 11 ? '0' : dvEsperado === 10 ? 'K' : dvEsperado.toString();
    return dv === dvCalc;
  }

  function validarEmail(email) {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
  }

  // Validar antes de enviar el formulario de edición
document.getElementById('formEditar').addEventListener('submit', function (e) {
  const rut = document.getElementById('edit-rut').value.trim();
  const correo = document.getElementById('edit-correo').value.trim();
  const rutError = document.getElementById('rut-error');
  const correoError = document.getElementById('correo-error');

  let valido = true;

  // Validar RUT solo si no está vacío
  if (rut && !validarRut(rut)) {
    rutError.classList.remove('hidden');
    valido = false;
  } else {
    rutError.classList.add('hidden');
  }

  // Validar correo solo si no está vacío
  if (correo && !validarEmail(correo)) {
    correoError.classList.remove('hidden');
    valido = false;
  } else {
    correoError.classList.add('hidden');
  }

  if (!valido) {
    e.preventDefault();
    return;
  }

  // Formatear RUT antes de enviar
  document.getElementById('edit-rut').value = formatearRut(rut);
});

function formatearRut(rut) {
  rut = rut.replace(/\./g, '').replace('-', '');
  const cuerpo = rut.slice(0, -1);
  const dv = rut.slice(-1);
  return cuerpo.replace(/\B(?=(\d{3})+(?!\d))/g, ".") + "-" + dv;
}

</script>

{% endblock %}